<html lang="de">
    <head>
        <meta charset='UTF-8' />
        <title>Out In The Open Kalendar</title>
        <link rel="stylesheet" type="text/css" href="js/leaflet-1.9.4.min.css">
        <script src='js/fullcalendar-6.1.15.min.js'></script>
        <script src='js/fullcalendar-6.1.15-de.min.js'></script>
        <script src='js/ical.js'></script>
        <script src='js/fullcalendar-6.1.15-ical.min.js'></script>
        <script src='js/leaflet-1.9.4.min.js'></script>
        <style>

            body {
              margin: 0;
              padding: 0;
              font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
              font-size: 14px;
            }

            #script-warning {
              display: none;
              background: #eee;
              border-bottom: 1px solid #ddd;
              padding: 0 10px;
              line-height: 40px;
              text-align: center;
              font-weight: bold;
              font-size: 12px;
              color: red;
            }

            #loading {
              display: none;
              position: absolute;
              top: 10px;
              right: 10px;
            }

            #calendar {
              max-width: 1100px;
              margin: 40px auto;
              padding: 0 10px;
            }

    		#eventMap {
    		    height: 600px;
    		    margin: 20px;
    		    margin-top: 10px;
    		}
        </style>
    </head>
    <body>
        <div id='script-warning'>
            <code>events.ics</code> nicht gefunden
        </div>
        <div id='loading'>Lade...</div>
        <div id='calendar'></div>

        <label style="margin-left: 20px" for="startdate">Zwischen</label>
        <input id="startdate" type="date" />
        <label for="enddate">und</label>
        <input id="enddate" type="date" />
        <button onclick="filterEvents()">eingrenzen</button>
        <div id="eventMap"></div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
              var calendarEl = document.getElementById('calendar');
              var calendar = new FullCalendar.Calendar(calendarEl, {
                  locale: 'de',
                  initialView: 'dayGridMonth',
                  displayEventTime: true,
                  initialDate: '2025-03-01',
                  navLinks: true,
                  dayMaxEvents: true,
                  headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                  },
                  events: {
                    url: 'ics/events.ics',
                    format: 'ics',
                    failure: function() {
                      document.getElementById('script-warning').style.display = 'block';
                    }
                  },
                  loading: function(bool) {
                    document.getElementById('loading').style.display =
                      bool ? 'block' : 'none';
                  }
                });
                calendar.render();
            });
            var now = new Date();
            document.getElementById('startdate').value = now.toISOString().split('T')[0];
            document.getElementById('enddate').value = new Date(now.getFullYear(), now.getMonth()+1, 1).toISOString().split('T')[0];
            var coords = [ 51.1638175, 10.4478313 ];
            var zoom = 6;
            var map = L.map('eventMap').setView(coords, zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            var events = [];
            var loadIcsData = () => {
                var reader = new FileReader();
                var icalStr = reader.readAsText('ics/events.ics');
                var vevents = new ICAL.Component(ICAL.parse(icalStr)).getAllSubcomponents('vevents');
                for (var vevent of vevents) {
                    var event = ICAL.Event(vevent);
                    var loc = event.location.split(',');
                    var lat = parseFloat(loc[0]);
                    var lon = parseFloat(loc[1]);
                    events.push({
                        summary: event.summary,
                        start: event.startDate.toJSDate(),
                        end: event.endDate.toJSDate(),
                        coords: [lat, lon]
                    });
                }
            };
            var eventDetails = (evt) => {
                var content = "<b>" + event.summary + "</b>";

                return content;
            };
            var showEvents = (evts) => {
                for (var evt of evts) {
                    L.marker(event.coords).addTo(map).bindPopup(eventDetails(event));
                }
            };
            showEvents(events);
            function filterEvents() {
                var startDate = new Date(document.getElementById('startdate').value);
                var endDate = new Date(document.getElementById('enddate').value);
                var filteredEvents = events.filter((evt) => evt.start >= startDate && evt.end <= endDate);
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                showEvents(filteredEvents);
            }
        </script>

    </body>
</html>